<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>清洗前後拼貼照片分享</title>
  <meta name="description" content="上傳清洗前後拼貼照片，加入說明、拖曳排序，並一鍵產生分享連結與 ZIP 下載。" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" defer></script>
  <style>
    :root { color-scheme: light dark; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:0.75rem 1rem; border-radius: 1rem; border:1px solid rgba(100,116,139,.5); font-weight:600; }
    .btn-primary { background:#0f172a; color:#fff; border-color:transparent; box-shadow:0 10px 24px rgba(15,23,42,.15); }
    .btn-ghost { background:rgba(255,255,255,.6); border-color:rgba(148,163,184,.5); }
    .input { width:100%; border-radius:0.75rem; border:1px solid rgba(100,116,139,.6); padding:0.75rem 1rem; background:rgba(255,255,255,.75); }
    .card { border:1px solid rgba(100,116,139,.3); background:rgba(255,255,255,.75); border-radius:1.25rem; box-shadow:0 6px 24px rgba(15,23,42,.06); }
    .row { display:flex; gap:12px; align-items:center; padding:12px; border:1px dashed rgba(100,116,139,.35); border-radius:1rem; background:rgba(255,255,255,.6); position:relative; }
    .handle { cursor:grab; padding:6px 8px; border-radius:10px; background:#e2e8f0; color:#334155; user-select:none; touch-action:none; }
    .thumb { width:80px; height:80px; border-radius:12px; overflow:hidden; background:#e2e8f0; flex:none; display:flex; align-items:center; justify-content:center; font-size:12px; color:#64748b; }
    .progress { height:8px; background:rgba(148,163,184,.35); border-radius:9999px; overflow:hidden; }
    .bar { height:100%; width:0; background:#0f172a; transition:width .25s ease; }
    .chip { font-size:12px; padding:4px 10px; border-radius:9999px; background:#f1f5f9; color:#334155; }
    .tap { min-height:44px; min-width:44px; }
    /* Lightbox */
    .lightbox { position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index:60; padding:env(safe-area-inset-top) 16px env(safe-area-inset-bottom); }
    .lightbox.open { display:flex; }
    .lightbox img { max-width:95vw; max-height:85vh; border-radius:16px; }
    .lightbox .caption { color:#e2e8f0; margin-top:10px; text-align:center; font-size:16px; }
    .lightbox .close { position:absolute; top:16px; right:16px; color:#e2e8f0; font-size:24px; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200/60">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
      <!-- 調整：頁首 LOGO 加大 -->
      <img src="logo1.png" alt="logo1" class="h-20 w-20 rounded-xl object-contain">
      <div class="leading-tight">
        <div class="font-semibold">自然大叔 Natural Uncle</div>
        <div class="text-[12px] text-slate-500">清洗前後拼貼照片分享</div>
      </div>
      <a href="tel:0912356331" class="ml-auto btn btn-primary tap">撥打 0912-356-331</a>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6">
    <section id="editor" class="card p-5">
      <h1 class="text-xl font-bold mb-4">建立分享</h1>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm mb-1 text-slate-600">案件/地點</label><input id="title" class="input" placeholder="例如：台北王小姐" /></div>
        <div><label class="block text-sm mb-1 text-slate-600">服務日期</label><input id="date" type="date" class="input" /></div>
      </div>

      <div class="mt-4">
        <label class="block text-sm mb-2 text-slate-600">照片清單（可拖曳排序）</label>
        <div id="items" class="space-y-3"></div>
        <div class="flex flex-wrap gap-2 mt-2">
          <button id="addItem" class="btn btn-ghost tap">＋ 新增一張</button>
          <label class="btn btn-ghost tap cursor-pointer">
            相簿選取多張
            <input id="multiPick" type="file" accept="image/*" multiple class="hidden" />
          </label>
        </div>
        <p class="text-xs text-slate-500 mt-2">支援 JPG/PNG，單檔 ≤ 10MB。拖曳左側「⋮⋮」手把調整順序。</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div><label class="block text-sm mb-1 text-slate-600">標籤（選填）</label><input id="tags" class="input" placeholder="以逗號分隔，例如：冷氣, 住家" /></div>
        <div><label class="block text-sm mb-1 text-slate-600">自訂網址代稱（選填）</label><input id="slug" class="input" placeholder="例如：wang-2025-09" /></div>
      </div>

      <div class="mt-5 flex items-center gap-3">
        <button id="upload" class="btn btn-primary tap">上傳全部並產生連結</button>
        <div class="grow progress"><div id="bar" class="bar"></div></div>
        <span id="progress" class="text-sm text-slate-600 min-w-[5rem]"></span>
      </div>
    </section>

    <section id="viewer" class="hidden">
      <article class="card overflow-hidden">
        <div class="p-5 border-b border-slate-200/60">
          <div class="flex items-start gap-3">
            <div class="grow">
              <h2 id="v-title" class="text-xl md:text-2xl font-semibold"></h2>
              <p class="text-sm text-slate-600 mt-1"><span id="v-date"></span></p>
              <div id="v-tags" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
            <a id="downloadZip" class="btn btn-ghost tap" target="_blank" rel="noopener">下載全部（ZIP）</a>
          </div>
        </div>
        <!-- 調整：縮小顯示 1/3（以 Cloudinary 轉換縮圖），caption 放大 -->
        <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 gap-3 p-4"></div>

        <div id="share-link" class="hidden px-5 pb-4">
          <div class="card p-4 flex flex-col md:flex-row md:items-center gap-3">
            <input id="share-url" class="input md:flex-1" readonly />
            <button id="copy-link" class="btn btn-primary tap md:w-auto w-full">複製連結</button>
          </div>
        </div>

        <div class="p-5 border-t border-slate-200/60 text-center">
          <!-- 調整：頁尾 LOGO 略小 -->
          <img src="logo.png" alt="公司Logo" class="mx-auto mb-3 max-h-16" loading="lazy"/>
          <p class="text-sm font-semibold">自然大叔 Natural Uncle 專業清淨職人</p>
          <p class="text-sm mt-1">聯絡電話：<a href="tel:0912356331" class="text-blue-600">0912-356-331</a></p>
        </div>
      </article>
    </section>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="圖片放大檢視">
    <button class="close" aria-label="關閉">✕</button>
    <div class="content text-center">
      <img id="lb-img" alt="放大圖片" />
      <div id="lb-cap" class="caption"></div>
    </div>
  </div>

  <script>
  // 兼容：桌機 / iOS / Android
  document.addEventListener('DOMContentLoaded', () => {
    const CLOUD_NAME="dijzndzw2";
    const UPLOAD_PRESET="unsigned_collages";
    const MAX_MB=10;
    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const setProgress=m=>$('#progress').textContent=m||'';
    const setBar=p=>$('#bar').style.width=Math.max(0,Math.min(100,p))+'%';
    const slugify=s=>String(s).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    // Cloudinary 轉換：gallery 縮小 1/3；lightbox 顯示較大
    function transform(url, opts){
      if(!url) return url;
      const i=url.indexOf('/upload/');
      if(i<0) return url;
      const inject = opts || 'f_auto,q_auto';
      return url.slice(0,i+8)+inject+'/'+url.slice(i+8);
    }
    const galleryUrl = (u)=> transform(u, 'f_auto,q_auto,c_limit,w_900');     // 縮小
    const lightboxUrl = (u)=> transform(u, 'f_auto,q_auto,c_limit,w_1600');   // 放大但控制大小

    // ===== Row factory =====
    function addItemRow(file){
      const itemsBox = $('#items');
      const row=document.createElement('div');
      row.className='row';
      row.innerHTML=`
        <div class="handle" title="拖曳調整順序">⋮⋮</div>
        <div class="thumb">預覽</div>
        <div class="flex-1 grid gap-2">
          <input type="file" accept="image/*" class="input p-2" aria-label="選擇圖片" />
          <input type="text" class="input" placeholder="照片說明（例如：房間冷氣）" />
        </div>
        <button class="btn btn-ghost tap remove">刪除</button>`;
      itemsBox.appendChild(row);

      const fileInput=$('input[type=file]',row);
      const thumb=$('.thumb',row);

      function setPreviewFromFile(f){
        const fr=new FileReader();
        fr.onload=()=>{ thumb.innerHTML='<img alt="預覽" class="w-full h-full object-cover" src="'+fr.result+'"/>'; };
        fr.readAsDataURL(f);
      }
      $('.remove',row).addEventListener('click',()=>row.remove());
      fileInput.addEventListener('change',()=>{
        const f=fileInput.files[0]; if(!f) return;
        if(f.size>MAX_MB*1024*1024){ alert('圖片超過 '+MAX_MB+'MB'); fileInput.value=''; return; }
        row._file = f;
        setPreviewFromFile(f);
      });

      if (file) {
        try {
          const dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;
          fileInput.dispatchEvent(new Event('change'));
        } catch {
          row._file = file;
          setPreviewFromFile(file);
        }
      }
    }

    $('#addItem').addEventListener('click',()=> addItemRow());
    $('#multiPick').addEventListener('change',e=>{
      const files=Array.from(e.target.files||[]);
      files.forEach(f=> addItemRow(f));
      e.target.value='';
    });
    addItemRow();

    // 拖曳排序
    if (window.Sortable) {
      new Sortable($('#items'),{
        animation:150, handle:'.handle',
        onStart:e=>e.item.classList.add('opacity-70'),
        onEnd:  e=>e.item.classList.remove('opacity-70')
      });
    }

    // Cloudinary 上傳
    async function uploadToCloudinary(file,folder){
      const fd=new FormData();
      fd.append('file',file);
      fd.append('upload_preset',UPLOAD_PRESET);
      fd.append('folder',folder);
      const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:'POST',body:fd});
      const j=await res.json().catch(()=>({}));
      if(!res.ok||!j.secure_url) throw new Error(j.error?.message||'Cloudinary upload failed');
      return j.secure_url;
    }

    // 上傳全部
    $('#upload').addEventListener('click', async ()=>{
      const title=$('#title').value.trim();
      const date=$('#date').value;
      const tags=$('#tags').value.trim();
      let slug=$('#slug').value.trim();
      const rows=$$('#items>.row');
      if(!rows.length) return alert('請至少新增一張');
      if(!slug) slug=slugify((title||'case')+'-'+Date.now().toString().slice(-6));

      try{
        setBar(0); setProgress('準備上傳…');
        const folder=`collages/${slug}`;
        const items=[]; let done=0;

        for (const row of rows){
          const f = $('input[type=file]',row)?.files?.[0] || row._file;
          const caption = $('input[type=text]',row)?.value?.trim() || '';
          if(!f){ alert('有一列未選圖片'); return; }
          if(f.size>MAX_MB*1024*1024) { alert('有圖片超過 '+MAX_MB+'MB'); return; }
          setProgress(`上傳中… ${done+1} / ${rows.length}`);
          const url = await uploadToCloudinary(f, folder);
          items.push({ url, caption });
          done++; setBar(done/rows.length*100);
        }

        setProgress('儲存資料…');
        const resp = await fetch('/.netlify/functions/create-post',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ title, date, tags, slug, items })
        });
        const txt = await resp.text();
        let data; try{ data = JSON.parse(txt); }catch{ data = { error: txt }; }
        if(!resp.ok || !data.ok) throw new Error(data.error || '建立失敗');

        const shareUrl = location.origin + location.pathname + '#/v/' + encodeURIComponent(data.slug);
        location.hash = '#/v/' + encodeURIComponent(data.slug);
        $('#share-url').value = shareUrl;
        $('#share-link').classList.remove('hidden');
        $('#copy-link').onclick = ()=> navigator.clipboard.writeText(shareUrl).then(()=> alert('已複製連結！'));
        setProgress('完成！');
      }catch(e){
        setProgress(''); setBar(0);
        alert('建立失敗：' + (e.message || e));
        console.error(e);
      }
    });

    // 檢視頁：縮圖顯示 + Lightbox 放大（不跳新頁）
    async function loadPost(slug){
      try{
        const r=await fetch('/.netlify/functions/get-post?slug='+encodeURIComponent(slug));
        const t=await r.text(); let d; try{ d=JSON.parse(t); }catch{ throw new Error(t); }
        if(d.error) throw new Error(d.error);

        $('#editor').classList.add('hidden');
        $('#viewer').classList.remove('hidden');
        $('#v-title').textContent=d.title||'未命名案件';
        $('#v-date').textContent=d.date? new Date(d.date).toLocaleDateString() : '';
        const tagsBox=$('#v-tags'); tagsBox.innerHTML='';
        (d.tags||'').split(',').map(x=>x.trim()).filter(Boolean).forEach(t=>{
          const s=document.createElement('span'); s.className='chip'; s.textContent='#'+t; tagsBox.appendChild(s);
        });

        const g=$('#gallery'); g.innerHTML='';
        (d.items||[]).forEach((it,i)=>{
          const url=galleryUrl(it.url||'');
          const card=document.createElement('div'); card.className='card overflow-hidden';
          // 調整：caption 變大（text-base）
          card.innerHTML=`
            <button class="w-full group" data-full="${lightboxUrl(it.url||'')}" data-cap="${(it.caption||('照片 '+(i+1))).replace(/"/g,'&quot;')}">
              <img src="${url}" class="w-full h-auto object-contain" loading="lazy" alt="照片 ${i+1}"/>
            </button>
            <div class="p-3 text-base text-slate-700">${it.caption||('照片 '+(i+1))}</div>`;
          g.appendChild(card);
        });

        // 綁定 lightbox
        $$('#gallery button').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            $('#lb-img').src = btn.dataset.full;
            $('#lb-cap').textContent = btn.dataset.cap || '';
            $('#lightbox').classList.add('open');
          }, { passive: true });
        });

        // ZIP 下載（自動檔名）
        const zipUrl='/.netlify/functions/zip-images?slug='+encodeURIComponent(slug);
        $('#downloadZip').href=zipUrl;

        // guest 看不到分享連結框
        $('#share-link').classList.add('hidden');
      }catch(e){
        alert('讀取失敗：' + (e.message || e));
        console.error(e);
      }
    }

    // Lightbox 關閉
    (function initLightbox(){
      const lb = $('#lightbox');
      const close = $('.close', lb);
      function hide(){ lb.classList.remove('open'); $('#lb-img').src=''; }
      close.addEventListener('click', hide);
      lb.addEventListener('click', (e)=>{ if(e.target===lb) hide(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hide(); });
    })();

    function route(){
      const h=location.hash||'#/new';
      if (h.startsWith('#/v/')) loadPost(decodeURIComponent(h.replace('#/v/','')));
      else { $('#viewer').classList.add('hidden'); $('#editor').classList.remove('hidden'); }
    }
    window.addEventListener('hashchange', route, { passive: true }); route();
  });
  </script>
</body>
</html>
